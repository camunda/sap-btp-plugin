_schema-version: "3.1"
ID: Camunda-BTP-Integration
version: 1.0.0-alpha.1
description: "BTP Integration, part of Camunda's SAP Integration"
parameters:
  enable-parallel-deployments: true

build-parameters:
  before-all:
    - builder: custom
      commands:
        - echo "nothing to do, things are vendored :)"

modules:
  # app-router acting as primary traffic distributor
  - name: router
    type: approuter.nodejs
    path: router
    parameters:
      disk-quota: 512M
      memory: 256M
    properties:
      # 15 minutes
      INCOMING_CONNECTION_TIMEOUT: 900000
    requires:
      - name: uaa
      - name: dest-camunda-btp-integration
      - name: conn-camunda-btp-integration
      # - name: logs
      - name: srv-binding
        group: destinations
        properties:
          forwardAuthToken: true
          name: srv_api
          url: "~{srv-url}"
      - name: ui-binding
        group: destinations
        properties:
          forwardAuthToken: true
          name: ui
          url: "~{ui-url}"
    build-parameters:
      builder: custom
      commands:
        - npm install

  # CAP services and business logic
  - name: srv
    type: nodejs
    path: core
    parameters:
      buildpack: nodejs_buildpack
      disk-quota: 1G
      memory: 512M
    build-parameters:
      builder: custom
      commands:
        - echo "nothing to do, things are vendored :)"
    requires:
      - name: uaa
      - name: dest-camunda-btp-integration
      - name: conn-camunda-btp-integration
      # - name: logs
      # - name: BDaaS-db
    provides:
      - name: srv-binding # required by consumers of CAP services (e.g. approuter, ui)
        properties:
          srv-url: ${default-url}

  # UI5 freestyle UI
  - name: ui
    type: html5
    path: fiori-app
    parameters:
      disk-quota: 1G
      memory: 256M
    build-parameters:
      # build-result: dist
      builder: custom
      commands:
         - echo "nothing to do, things are vendored :)"
    requires:
      - name: uaa
      - name: dest-camunda-btp-integration
      - name: conn-camunda-btp-integration
      # - name: logs
    provides:
      - name: ui-binding # required by consumers of CAP services (e.g. approuter, ui)
        properties:
          ui-url: ${default-url}


resources:
  # services extracted from CAP configuration
  # 'service-plan' can be configured via 'cds.requires.<name>.vcap.plan'
  # ------------------------------------------------------------
  - name: uaa
    # ------------------------------------------------------------
    type: org.cloudfoundry.managed-service
    parameters:
      service: xsuaa
      service-plan: application
      path: ./core/xs-security.json
      config:
        xsappname: camunda-btp-integration #  name + space dependency
        tenant-mode: dedicated
  - name: dest-camunda-btp-integration
    type: org.cloudfoundry.managed-service
    parameters:
      service-plan: lite
      service: destination
  - name: conn-camunda-btp-integration
    type: org.cloudfoundry.managed-service
    parameters:
      service-plan: lite
      service: connectivity
  # - name: logs
  #   type: org.cloudfoundry.managed-service
  #   parameters:
  #     service-plan: lite
  #     service: application-logs

## //> revisit: move to postgres
  # - name: BDaaS-db
  #   type: com.sap.xs.hdi-container
  #   parameters:
  #     service: hana
  #     service-plan: hdi-shared
